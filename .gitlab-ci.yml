stages:
  - test
  - package
  - deploy


test-pytest:
  stage: test
  image: continuumio/miniconda3:latest
  before_script:
    - echo ${CI_PROJECT_DIR}
    - export PIP_CACHE_DIR="/opt/cache/pip"
    - /opt/conda/bin/conda init && source /root/.bashrc
    - conda config --env --add channels conda-forge
    - conda config --env --append channels esrf-bcu
    - conda config --env --append channels tango-controls
    - conda install --yes python=3.7
    - conda install --yes lima-core pytango
    - conda install --yes pytest fabio
    - conda install --yes pip
    - pip install . -vv
  script:
    - pytest tests
  artifacts:
    paths:
      - dist/
  tags:
    - conda


package-noarch:
  stage: package
  script:
    - conda build ./conda --prefix-length=80 --output-folder=dist/ -c tango-controls --channel=http://bcu-ci.esrf.fr/stable -c conda-forge
  artifacts:
    paths:
      - dist/
  tags:
    - conda


deploy_devel:
  stage: deploy
  environment:
    name: devel/$CI_COMMIT_REF_NAME
    url: http://bcu-ci.esrf.fr/devel
  dependencies:
    - package-noarch
  script:
    - cp -Rf dist/* /conda-devel/
    - conda index /conda-devel/
  tags:
    - conda
    - linux
  only:
    - branches
  except:
    - stable
  when: manual

deploy_stable:
  stage: deploy
  environment:
    name: production
    url: http://bcu-ci.esrf.fr/stable
  dependencies:
    - package-noarch
  script:
    - cp -Rf dist/* /conda/
    - conda index /conda/
  tags:
    - conda
    - linux
  only:
    - tags
    - stable
